from flask import send_file

from pyfsw import app
from pyfsw import BASE_PATH

from PIL import Image
from os import path

OUTFIT_OUTPUT = path.join(BASE_PATH, 'static', 'img', 'outfits', 'cache')
OUTFIT_MASKS = path.join(BASE_PATH, 'static', 'img', 'outfits', 'mask')
OUTFIT_SHADOWS = path.join(BASE_PATH, 'static', 'img', 'outfits', 'shadow')

TIBIA_COLORS  = (
	(254, 254, 254, 255), (255, 213, 191, 255), (254, 232, 191, 255),
	(255, 255, 191, 255), (233, 255, 191, 255), (209, 253, 190, 255),
	(193, 255, 192, 255), (191, 254, 211, 255), (191, 254, 233, 255),
	(191, 255, 255, 255), (192, 232, 255, 255), (192, 211, 253, 255),
	(191, 193, 254, 255), (211, 191, 254, 255), (234, 192, 255, 255),
	(253, 191, 255, 255), (252, 191, 233, 255), (254, 191, 212, 255),
	(252, 191, 190, 255), (218, 218, 218, 255), (190, 159, 141, 255),
	(190, 175, 144, 255), (191, 190, 144, 255), (174, 190, 143, 255),
	(159, 191, 142, 255), (143, 191, 143, 255), (146, 191, 160, 255),
	(144, 191, 175, 255), (145, 191, 191, 255), (142, 175, 192, 255),
	(144, 159, 192, 255), (143, 144, 192, 255), (160, 142, 190, 255),
	(175, 143, 192, 255), (191, 143, 191, 255), (190, 143, 175, 255),
	(192, 144, 160, 255), (190, 144, 144, 255), (182, 182, 182, 255),
	(192, 127,  95, 255), (190, 161,  93, 255), (191, 191,  95, 255),
	(159, 190,  96, 255), (127, 191,  95, 255), ( 94, 189,  95, 255),
	( 96, 192, 128, 255), ( 95, 190, 158, 255), ( 96, 192, 191, 255),
	( 95, 160, 192, 255), ( 97, 126, 192, 255), ( 96,  94, 191, 255),
	(129,  95, 192, 255), (159,  95, 191, 255), (191,  93, 192, 255),
	(191,  95, 159, 255), (191,  94, 127, 255), (190,  94,  96, 255),
	(145, 145, 145, 255), (193, 105,  65, 255), (190, 148,  64, 255),
	(191, 190,  64, 255), (149, 191,  63, 255), (106, 192,  67, 255),
	( 64, 190,  64, 255), ( 62, 189, 108, 255), ( 60, 191, 147, 255),
	( 61, 191, 189, 255), ( 65, 148, 192, 255), ( 65, 107, 193, 255),
	( 64,  61, 190, 255), (108,  63, 190, 255), (148,  63, 190, 255),
	(192,  62, 194, 255), (192,  64, 149, 255), (189,  64,  10, 255),
	(190,  62,  63, 255), (110, 110, 110, 255), (255,  84,   0, 255),
	(255, 170,   0, 255), (255, 255,   0, 255), (168, 255,   0, 255),
	( 81, 255,   0, 255), (  0, 255,   1, 255), (  0, 255,  85, 255),
	(  0, 255, 169, 255), (  1, 255, 255, 255), (  1, 169, 255, 255),
	(  0,  86, 253, 255), (  1,   0, 254, 255), ( 83,   0, 254, 255),
	(170,   0, 255, 255), (254,   0, 253, 255), (253,   0, 169, 255),
	(254,   0,  86, 255), (254,   0,   0, 255), ( 72,  72,  72, 255),
	(189,  64,   0, 255), (191, 128,   0, 255), (191, 190,   1, 255),
	(128, 191,   0, 255), ( 65, 190,   0, 255), (  1, 192,   1, 255),
	(  0, 192,  62, 255), (  2, 191, 127, 255), (  1, 191, 191, 255),
	(  0, 127, 190, 255), (  0,  64, 196, 255), (  0,   1, 190, 255),
	( 62,   0, 192, 255), (128,   1, 192, 255), (191,   0, 191, 255),
	(194,   0, 127, 255), (190,   0,  62, 255), (190,   0,   0, 255),
	( 36,  36,  36, 255), (127,  42,   1, 255), (127,  85,   0, 255),
	(127, 128,   0, 255), ( 84, 126,   0, 255), ( 42, 127,   0, 255),
	(  1, 127,   1, 255), (  0, 127,  42, 255), (  1, 128,  87, 255),
	(  0, 127, 126, 255), (  0,  85, 126, 255), (  1,  43, 127, 255), 
	(  0,   0, 127, 255), ( 42,   0, 126, 255), ( 85,   0, 127, 255),
	(127,   1, 127, 255), (127,   1,  83, 255), (127,   0,  41, 255),
	(128,   0,   0, 255)
)

def cmp_color(a, b):
	return a[0] == b[0] and a[1] == b[1] and a[2] == b[2]

@app.route('/outfit/<int:type>/<int:head>/<int:body>/<int:legs>/<int:feet>/<int:addon>')
def route_outfit(type, head, body, legs, feet, addon):
	name_in = '{}_{}.png'.format(type, addon)
	name_out = '{}_{}_{}_{}_{}_{}.png'.format(type, head, body, legs, feet, addon)
	path_out = path.join(OUTFIT_OUTPUT, name_out)

	if path.exists(path_out):
		return send_file(path_out, 'image/png')

	path_mask = path.join(OUTFIT_MASKS, name_in)
	path_shadow = path.join(OUTFIT_SHADOWS, name_in)

	if not path.exists(path_shadow):
		return send_file(path.join(BASE_PATH, 'static', 'img', 'gm.png'))

	mask = Image.open(path_mask)
	shadow = Image.open(path_shadow)

	mask_rw = mask.load()
	shadow_rw = shadow.load()

	for x in range(64):
		for y in range(64):
			rgb = mask_rw[x, y]
			if cmp_color(rgb, (255, 255, 0)):
				mask_rw[x, y] = TIBIA_COLORS[head]

			if cmp_color(rgb, (255, 0, 0)):
				mask_rw[x, y] = TIBIA_COLORS[body]

			if cmp_color(rgb, (0, 255, 0)):
				mask_rw[x, y] = TIBIA_COLORS[legs]

			if cmp_color(rgb, (0, 0, 255)):
				mask_rw[x, y] = TIBIA_COLORS[feet]

	for x in range(64):
		for y in range(64):
			rgb_mask = mask_rw[x, y]
			rgb_shadow = shadow_rw[x, y]
			if rgb_mask[3] == 255:
				shadow_rw[x, y] = (
					int((rgb_mask[0] * rgb_shadow[0] / 255)),
					int((rgb_mask[1] * rgb_shadow[1] / 255)),
					int((rgb_mask[2] * rgb_shadow[2] / 255)),
					255
				)

	shadow.save(path_out)
	return send_file(path_out, 'image/png')
